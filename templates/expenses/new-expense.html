<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <title>New Expense</title>
</head>
<body onload="form_reset()">
    {% if error_message %} <p><strong>{{ error_message }}</strong></p>{% endif %}
    <form action="{% url 'expenses:new_expense' %}" id="expense-form" method="post">
        {% csrf_token %}
        <label for="search-product">Product</label>
        <input type="search" list="product-search-results" id="search-product" name="search-product" onkeyup="filter_products()" placeholder="Products..."><br>
        <datalist id="product-search-results"></datalist>
        <label for="purchase-date">Date of Purchase</label>
        <input type="date" id="purchase-date" name="purchase-date" value=""><br>
        <label for="purchase-price">Purchase Price</label>
        <input type="number" id="purchase-price" name="purchase-price", min="0.01", step="0.01", max="9999.99"><br>
        <button type="submit" id="submit-expense" name="submit-expense">Submit</button>
        <button type="reset" id="clear-expense" name="clear-expense" onclick="form_reset()">Clear</button>
        <a href="recent-expenses">Cancel</a>
    </form>
</body>
    <script>

        function form_reset() {
            document.getElementById('purchase-date').value = new Date().toISOString().split('T')[0];
        }

        function filter_products() {
            const search_input = $("#search-product").val();
            $.ajax({
                type: 'GET',
                url: "{% url 'expenses:filter_products' %}",
                data: {"product_filter": search_input},
                success: function (response) {
                    var dl = document.getElementById("product-search-results");
                    if ($('#product-search-results').length != 0) {
                        $('#product-search-results').empty();
                    }
                    var search_results = $.parseJSON(response);
                    for (const [prod_desc, prod_id] of Object.entries(search_results)) {
                        var op = document.createElement("option");
                        op.value = prod_desc + ":" + prod_id;
                        dl.appendChild(op);
                    }

                },
                error: function (response) {
                    console.log(response)
                }
            })
        }

    </script>
</html>